# ================================================================================
# PROJECT METADATA
# ================================================================================
# Project Name     : FusionIQ AIML Platform
# Dockerfile Name  : API-Gateway-AIML-Microservice
# Maintained By    : DevOps Team @ Surnoi Technology Pvt Ltd
# Developed By     : AI/ML Development Team
# Pipeline Owner   : Kanaparthi Siddhartha (DevOps Engineer)
# Purpose          : Secure, multi-stage build for API Gateway microservice
# ================================================================================

# Dockerfile for JobTestcase-aiml-microservices
FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Install system dependencies (MySQL client, Redis, build tools, FFmpeg)
RUN apt-get update && apt-get install -y \
    default-mysql-client \
    default-libmysqlclient-dev \
    redis-server \
    gcc \
    make \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# Create a non-root user named 'fusionIQ' and set up home directory
RUN useradd -m -s /bin/bash fusionIQ

# Set environment variable to include user-installed binaries
ENV PATH="/home/fusionIQ/.local/bin:${PATH}"

# Copy requirements and install Python dependencies as 'fusionIQ'
COPY --chown=fusionIQ:fusionIQ requirements.txt .
RUN pip install --no-cache-dir --user -r requirements.txt

# Copy application code and give ownership to 'fusionIQ'
COPY --chown=fusionIQ:fusionIQ . .

# Switch to non-root user
USER fusionIQ

# Expose ports (Python + Redis)
EXPOSE 8003 6379

# Start Redis in background and run Python service
CMD redis-server --daemonize yes && \
    echo "Redis started..." && \
    python integration.py
